<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Midgard Viewport! (F11 f√ºr Fullscreen)</title>
    <script>window.$ = window.jQuery = require('./js/jquery.js');</script>
    <script src="./js/vendor.js"></script> 
    <script src="./js/jquery.lettering.js"></script> 
    <script src="./js/fittext.js"></script> 

    <script>
      const ipcRenderer = require('electron').ipcRenderer;
      var $panzoom

      ipcRenderer.on('asynchronous-reply', function(event, arg) {        
        $('.message').html("<h2><div>"+arg+"</div></h2>");        
      }); 

      ipcRenderer.on('image-reply', function(event, arg) {

        loadCanvas($('.image').find('canvas')[0],arg);
        $('.image').find('canvas').attr("data-path", arg);

        $panzoom = $('.panzoom').panzoom();
      }); 

      ipcRenderer.on('image-change-reply', function(event, arg) {        
        //$panzoom.off('panzoomchange');
        console.log("change")
        
        $panzoom.panzoom("setMatrix", arg);

      /*  $panzoom.on('panzoomchange', function(e, panzoom, transform) {
          ipcRenderer.send("image-change", transform);
        }); */
      }); 

      ipcRenderer.on('viewport-change', function(event, arg) {
        $panzoom.panzoom('reset');
        $panzoom.panzoom('resetDimensions');        
      }); 

      ipcRenderer.on('toggle-image-reply', function(event, arg) {
        var oldPath = $('.image').find('canvas').attr("data-path");
        if (oldPath != arg.path) {
          $('.image').find('canvas').attr("data-path", arg.path);
          loadCanvas($('.image').find('canvas')[0], arg.path);
          $panzoom.panzoom('reset');
          $panzoom.panzoom('resetDimensions');
        }
        $('.image').find('canvas').css('display',arg.display);
      });

      function loadCanvas(canvas, dataURL) {     
        var context = canvas.getContext('2d');

        // load image from data url
        var imageObj = new Image();
        imageObj.onload = function() {
          $(canvas).attr("width",imageObj.naturalWidth).attr("height",imageObj.naturalHeight);
          context.drawImage(this, 0, 0);
        };

        imageObj.src = dataURL;
      }
    </script>
    <link rel="stylesheet" href="./css/viewport.css">

  </head>
  <body style="margin:0px; font-family: 'kingthings_foundationregular'">
    <canvas id="fog" style="width: 100vw; height: 100vh; display:block;"></canvas>
	
    <script src="./js/fog.js"></script> 

    <div class="message">
    </div>

    <div class="image">
      <div class="overflow" style="width:100vw; height:100vh;"><div class="panzoom"><canvas style="display:none"></canvas></div>
    </div>
  </body>
</html>
